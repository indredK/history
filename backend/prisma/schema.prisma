// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 来源表：所有数据的原始来源
model Source {
  id         String   @id @default(uuid())
  title      String   @db.VarChar(255)
  author     String?  @db.VarChar(255)
  url        String?
  license    String?  @db.VarChar(50)
  confidence Float    @default(0.8)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  persons    Person[]
  events     Event[]
  places     Place[]
  adminUnits AdminUnit[]
  boundaries MapBoundaryVersion[]

  @@index([title])
  @@map("sources")
}

// 人物表：历史人物信息
model Person {
  id           String   @id @default(uuid())
  name         String   @db.VarChar(100)
  nameEn       String?  @db.VarChar(200)
  birthYear    Int?
  birthMonth   Int?
  deathYear    Int?
  deathMonth   Int?
  biography    String?  @db.Text
  roles        String[]
  confidence   Float    @default(0.8)
  contributors String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  sourceIds String[]
  sources   Source[]      @relation(fields: [sourceIds], references: [id])
  events    EventParticipant[]

  @@index([name])
  @@index([birthYear])
  @@index([deathYear])
  @@map("persons")
}

// 事件表：历史事件
model Event {
  id           String   @id @default(uuid())
  title        String   @db.VarChar(200)
  titleEn      String?  @db.VarChar(300)
  startYear    Int
  startMonth   Int?
  endYear      Int
  endMonth     Int?
  description  String?  @db.Text
  eventType    String   @db.VarChar(50)
  confidence   Float    @default(0.8)
  contributors String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  sourceIds String[]
  sources   Source[] @relation(fields: [sourceIds], references: [id])
  participants EventParticipant[]
  locations    EventLocation[]

  @@index([startYear])
  @@index([endYear])
  @@index([eventType])
  @@map("events")
}

// 事件-人物关联
model EventParticipant {
  id       String @id @default(uuid())
  eventId  String
  personId String
  role     String? @db.VarChar(100)

  event  Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([eventId, personId])
  @@map("event_participants")
}

// 地点表：历史地名
model Place {
  id            String   @id @default(uuid())
  canonicalName String   @db.VarChar(100)
  altNames      String[]
  description   String?  @db.Text
  latitude      Float?
  longitude     Float?
  confidence    Float    @default(0.8)
  contributors  String[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sourceIds String[]
  sources   Source[] @relation(fields: [sourceIds], references: [id])
  events    EventLocation[]

  @@index([canonicalName])
  @@map("places")
}

// 事件-地点关联
model EventLocation {
  id      String @id @default(uuid())
  eventId String
  placeId String
  role    String? @db.VarChar(100)

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  place Place @relation(fields: [placeId], references: [id], onDelete: Cascade)

  @@unique([eventId, placeId])
  @@map("event_locations")
}

// 行政单元：朝代、省份等
model AdminUnit {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(100)
  nameEn    String?  @db.VarChar(200)
  type      String   @db.VarChar(50)
  parentId  String?
  validFrom Int
  validTo   Int?
  confidence Float   @default(0.8)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sourceIds String[]
  sources   Source[] @relation(fields: [sourceIds], references: [id])
  boundaries AdminUnitBoundary[]

  parent   AdminUnit?  @relation("AdminUnitHierarchy", fields: [parentId], references: [id])
  children AdminUnit[] @relation("AdminUnitHierarchy")

  @@index([validFrom])
  @@index([validTo])
  @@map("admin_units")
}

// 地图边界版本：地理边界数据
model MapBoundaryVersion {
  id           String   @id @default(uuid())
  name         String?  @db.VarChar(200)
  validFrom    Int
  validTo      Int?
  geometryType String?  @db.VarChar(50)
  geometryUrl  String?
  geometryHash String?  @db.VarChar(64)
  confidence   Float    @default(0.8)
  contributors String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  sourceIds String[]
  sources   Source[] @relation(fields: [sourceIds], references: [id])
  adminUnits AdminUnitBoundary[]

  @@index([validFrom])
  @@index([validTo])
  @@map("map_boundary_versions")
}

// 行政单元-边界关联
model AdminUnitBoundary {
  id                  String @id @default(uuid())
  adminUnitId         String
  boundaryVersionId   String

  adminUnit       AdminUnit @relation(fields: [adminUnitId], references: [id], onDelete: Cascade)
  boundaryVersion MapBoundaryVersion @relation(fields: [boundaryVersionId], references: [id], onDelete: Cascade)

  @@unique([adminUnitId, boundaryVersionId])
  @@map("admin_unit_boundaries")
}
